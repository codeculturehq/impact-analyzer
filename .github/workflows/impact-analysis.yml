# Impact Analysis GitHub Actions Workflow
# This workflow runs cross-repo impact analysis on pull requests

name: Impact Analysis

on:
  pull_request:
    branches: [main, master, develop]
  workflow_dispatch:
    inputs:
      base_ref:
        description: 'Base reference (commit/branch) for comparison'
        required: false
        default: 'main'
      head_ref:
        description: 'Head reference (commit/branch) to analyze'
        required: false
        default: 'HEAD'

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  impact-analysis:
    name: Analyze Impact
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: main-repo

      # Example: Checkout additional repos for cross-repo analysis
      # Uncomment and customize for your setup
      # - name: Checkout frontend repo
      #   uses: actions/checkout@v4
      #   with:
      #     repository: your-org/frontend
      #     path: repos/frontend
      #     token: ${{ secrets.REPO_ACCESS_TOKEN }}
      #
      # - name: Checkout api repo
      #   uses: actions/checkout@v4
      #   with:
      #     repository: your-org/api
      #     path: repos/api
      #     token: ${{ secrets.REPO_ACCESS_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: main-repo/package-lock.json

      - name: Install impact-analyzer
        run: npm install -g @codeculture/impact-analyzer

      - name: Determine refs
        id: refs
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "base_ref=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
            echo "head_ref=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
          else
            echo "base_ref=${{ inputs.base_ref || 'main' }}" >> $GITHUB_OUTPUT
            echo "head_ref=${{ inputs.head_ref || 'HEAD' }}" >> $GITHUB_OUTPUT
          fi

      - name: Run Impact Analysis
        id: analysis
        run: |
          cd main-repo
          impact-analyzer analyze \
            --base "${{ steps.refs.outputs.base_ref }}" \
            --head "${{ steps.refs.outputs.head_ref }}" \
            --format json,md \
            --output ./impact-report
        continue-on-error: true

      - name: Upload Impact Report
        uses: actions/upload-artifact@v4
        with:
          name: impact-report
          path: main-repo/impact-report/
          retention-days: 7

      # Optional: Post comment to PR
      - name: Comment on PR
        if: github.event_name == 'pull_request' && hashFiles('main-repo/impact-report/impact-analysis.md')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'main-repo/impact-report/impact-analysis.md';

            if (fs.existsSync(reportPath)) {
              const report = fs.readFileSync(reportPath, 'utf8');

              // Find existing comment
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });

              const botComment = comments.find(c =>
                c.user.type === 'Bot' &&
                c.body.includes('Impact Analysis')
              );

              const commentBody = `## ðŸ” Impact Analysis\n\n${report}\n\n---\n*Generated by [@codeculture/impact-analyzer](https://github.com/codeculturehq/impact-analyzer)*`;

              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: commentBody,
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: commentBody,
                });
              }
            }

      # Optional: Create GitHub Check with annotations
      - name: Create Check Run
        if: hashFiles('main-repo/impact-report/impact-analysis.json')
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'main-repo/impact-report/impact-analysis.json';

            if (fs.existsSync(reportPath)) {
              const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));

              const annotations = [];
              for (const repo of report.repos || []) {
                for (const impact of repo.impacts || []) {
                  annotations.push({
                    path: impact.file,
                    start_line: impact.line || 1,
                    end_line: impact.line || 1,
                    annotation_level: impact.reasons.some(r => r.type === 'schema') ? 'failure' : 'warning',
                    title: `Impact: ${impact.component}`,
                    message: impact.reasons.map(r => `[${r.type}] ${r.description}`).join('\n'),
                  });
                }
              }

              await github.rest.checks.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'Impact Analysis',
                head_sha: context.sha,
                status: 'completed',
                conclusion: report.summary?.hasBreakingChanges ? 'failure' : 'success',
                output: {
                  title: 'Impact Analysis Results',
                  summary: `Found ${report.summary?.totalImpactedComponents || 0} impacted components across ${report.summary?.totalChangedFiles || 0} files.`,
                  annotations: annotations.slice(0, 50),
                },
              });
            }

      # Optional: Send Slack notification
      - name: Notify Slack
        if: hashFiles('main-repo/impact-report/impact-analysis.json') && env.SLACK_WEBHOOK_URL
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          cd main-repo
          # Use the CLI to send Slack notification
          # Or use curl to send directly
          REPORT=$(cat impact-report/impact-analysis.json)
          TOTAL_IMPACTS=$(echo "$REPORT" | jq -r '.summary.totalImpactedComponents // 0')
          BREAKING=$(echo "$REPORT" | jq -r '.summary.hasBreakingChanges // false')

          if [ "$BREAKING" = "true" ]; then
            COLOR="danger"
            EMOJI=":warning:"
          elif [ "$TOTAL_IMPACTS" -gt 0 ]; then
            COLOR="warning"
            EMOJI=":mag:"
          else
            COLOR="good"
            EMOJI=":white_check_mark:"
          fi

          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$EMOJI Impact Analysis\",
                \"text\": \"Found $TOTAL_IMPACTS impacted components. Breaking changes: $BREAKING\",
                \"footer\": \"impact-analyzer\",
                \"ts\": $(date +%s)
              }]
            }" \
            "$SLACK_WEBHOOK_URL"
